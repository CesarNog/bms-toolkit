# Copyright 2020 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
  - name: sql_patch | SID confirmation
    debug:
      msg: "Running post patch operations for SID: {{ oracle_sid }}"

  - name: sql_patch | default upgrade mode
    set_fact:
      startup_upgrade: ""
    when: not patch.upgrade|bool

  - name: sql_patch | determine if upgrade mode is required
    set_fact:
      startup_upgrade: "upgrade"
    when: patch.upgrade|bool

  - name: sql_patch | startup db
    shell: |
      set -o pipefail
      echo "startup {{ startup_upgrade }};" | sqlplus -s / as sysdba
    environment:
      ORACLE_HOME: "{{ oracle_home }}"
      ORACLE_SID: "{{ oracle_sid }}"
      PATH: "{{ oracle_home }}/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin"
    register: startup_db
    become: yes
    become_user: "{{ oracle_user }}"
    tags: patch_rdbms,upgrade_db

  - name: sql_patch | startup db results
    debug:
      msg: "{{ startup_db }}"
      verbosity: 1
    tags: patch_rdbms,upgrade_db

  - name: sql_patch | startup PDB
    shell: |
      set -o pipefail
      echo "alter pluggable database all open {{ startup_upgrade }};" | sqlplus -s / as sysdba
    environment:
      ORACLE_HOME: "{{ oracle_home }}"
      ORACLE_SID: "{{ oracle_sid }}"
      PATH: "{{ oracle_home }}/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin"
    register: startup_pdb
    ignore_errors: yes
    become: yes
    become_user: "{{ oracle_user }}"
    when: oracle_ver != '11.2.0.4.0'
    tags: patch_rdbms,start_pdb

  - name: sql_patch | startup PDB results
    debug:
      msg: "{{ startup_pdb }}"
      verbosity: 1
    when: oracle_ver != '11.2.0.4.0'

  - name: sql_patch | Run datapatch
    shell: |
      {{ oracle_home }}/OPatch/datapatch -verbose
    environment:
      ORACLE_SID: "{{ oracle_sid }}"
      ORACLE_HOME: "{{ oracle_home }}"
      PATH: "{{ oracle_home }}/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin"
    when: oracle_ver != '11.2.0.4.0'
    register: datapatch_output
    failed_when: "datapatch_output.rc != 0"
    become: yes
    become_user: "{{ oracle_user }}"
    tags: patch_rdbms,datapatch

  - name: sql_patch | datapatch results
    debug:
      msg: "{{ datapatch_output }}"
      #verbosity: 1
    when: oracle_ver != '11.2.0.4.0'
    tags: patch_rdbms,datapatch

  - name: sql_patch | Run catbundle
    shell: |
      set -o pipefail
      echo "@catbundle.sql psu apply" | sqlplus -s / as sysdba
    args:
      chdir: "{{ oracle_home }}/rdbms/admin"
    environment:
      ORACLE_SID: "{{ oracle_sid }}"
      ORACLE_HOME: "{{ oracle_home }}"
      PATH: "{{ oracle_home }}/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin"
    when: oracle_ver == '11.2.0.4.0'
    register: catbundle_output
    failed_when: "catbundle_output.rc != 0"
    become: yes
    become_user: "{{ oracle_user }}"
    tags: patch_rdbms,catbundle

  - name: sql_patch | catbundle results
    debug:
      msg: "{{ catbundle_output }}"
      #verbosity: 1
    when: oracle_ver == '11.2.0.4.0'
    tags: patch_rdbms,catbundle

  - name: sql_patch | recompile invalid objects
    shell: |
      set -o pipefail
      echo "@?/rdbms/admin/utlrp;" | sqlplus -s / as sysdba
    environment:
      ORACLE_HOME: "{{ oracle_home }}"
      ORACLE_SID: "{{ oracle_sid }}"
      PATH: "{{ oracle_home }}/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin"
    become: yes
    become_user: "{{ oracle_user }}"
    tags: patch_rdbms,utlrp

  - name: sql_patch | capture registry patches
    shell: |
      set -o pipefail
      echo "
      set pages 0 lines 200
      col action_time for a28
      col action for a10
      col status for a10
      select action_time, action, status, patch_id from dba_registry_sqlpatch order by action_time;
      " | sqlplus -s / as sysdba
    environment:
      ORACLE_HOME: "{{ oracle_home }}"
      ORACLE_SID: "{{ oracle_sid }}"
      PATH: "{{ oracle_home }}/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin"
    when: oracle_ver != '11.2.0.4.0'
    register: patch_registry
    become: yes
    become_user: "{{ oracle_user }}"
    tags: patch_rdbms

  - name: sql_patch | registry patch results
    debug:
      msg: "{{ patch_registry }}"
    when: oracle_ver != '11.2.0.4.0'

  - name: sql_patch | shutdown db
    shell: |
      set -o pipefail
      echo "shutdown immediate" | sqlplus -s / as sysdba
    environment:
      ORACLE_HOME: "{{ oracle_home }}"
      ORACLE_SID: "{{ oracle_sid }}"
      PATH: "{{ oracle_home }}/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin"
    register: shutdown_db
    become: yes
    become_user: "{{ oracle_user }}"
    tags: patch_rdbms,upgrade_db

  - name: sql_patch | shutdown db results
    debug:
      msg: "{{ shutdown_db }}"
      verbosity: 1
    tags: patch_rdbms,upgrade_db
